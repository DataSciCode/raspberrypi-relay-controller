'use strict';

const Hapi = require('hapi');
const server = new Hapi.Server({
    connections: {
        routes: {
            files: {
                relativeTo: __dirname
            }
        }
    }
});
server.connection({ port: 3000 });

const rpio = require('rpio');
const defaultPinOnDuration = 500;

// Raspberry Pi Model B (P1 Header) schematic: http://pi4j.com/images/p1header-large.png
const relayToGpioPinMapping = {
    '1': 11,
    '2': 12
};

server.register(require('inert'), (err) => {

    if (err) {
        throw err;
    }

    // index.html static file
    server.route({
        method: 'GET',
        path: '/',
        handler: {
            file: 'index.html'
        }
    });

    // The REST endpoint for triggering the relay
    // Test: curl -X PUT -D - -H "Content-Type: application/json" -d '{ "relay":{"state":"closed"}}' http://localhost:3000/relays/1
    server.route({
        method: 'PUT',
        path: '/relays/{number}',
        handler: function (request, reply) {
            let relayNumber = request.params.number;
            let relay = request.payload.relay;
            if (relay.state === "triggered") {
                let relayPin = relayToGpioPinMapping[relayNumber];
                let duration = Number(relay.close_duration || defaultPinOnDuration);
                console.log(JSON.stringify(relay));
                toggleGpioPinOn(relayPin, duration);
            }

            reply().code(204);
        }
    });

    // Start hapi.js HTTP server
    server.start((err) => {
        if (err) {
            throw err;
        }
        console.log(`Server running at: ${server.info.uri}`);
    });
});

// Broadcast API metadata to UDP socket for discovery by other devices
const dgram = require('dgram');
const broadcastSocket = dgram.createSocket("udp4");
const broadcastPort = 41234;
const broadcastAddress = "255.255.255.255";
const broadcastMessage = JSON.stringify({
    source: "{{hostname}} relay API",
    endpoint: "relays/{relayNumber}",
    endpointMethod: "PUT",
    availableRelays: [1,2],
    availableStates: ["triggered"]
});
const broadcastIntervalMilliseconds = 60000;
broadcastSocket.bind(() => {
    broadcastSocket.setBroadcast(true);
    setInterval(function (socket) {
        console.log(`Broadcasting API metadata to: ${broadcastAddress}:${broadcastPort}`);
        broadcastSocket.send(broadcastMessage, broadcastPort, broadcastAddress);
    }, broadcastIntervalMilliseconds);
});

function toggleGpioPinOn(pin, durationMilliseconds) {
    // Set the initial state to low.
    rpio.open(pin, rpio.OUTPUT, rpio.LOW);
    // Turn pin ON.
    rpio.write(pin, rpio.HIGH);
    // Wait durationMilliseconds
    rpio.msleep(durationMilliseconds);
    // Turn pin OFF.
    rpio.write(pin, rpio.LOW);
}

// On startup, turn all the pins off.
for(let relay of Object.keys(relayToGpioPinMapping)) {
    let pin = relayToGpioPinMapping[relay];
    // Set the initial state to low.
    rpio.open(pin, rpio.OUTPUT, rpio.LOW);
    // Turn pin OFF.
    rpio.write(pin, rpio.LOW);
}
